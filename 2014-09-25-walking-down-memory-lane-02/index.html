<!doctype html><html lang=en-ca><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=G-X51Z9ZSVTG"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-X51Z9ZSVTG')</script><link rel=stylesheet href=/css/main.min.cbc1d077d2bc53c6bbb8dfb11bc9ed88ee0d6500df58907bf73992fa72cc2c9b.css integrity=sha256-y8HQd9K8U8a7uN+xG8ntiO4NZQDfWJB79zmS+nLMLJs=><script type=text/javascript src=/js/fonts.min.366cce719fca2057c3054290da9e8a6e94288295b9ba24bdd235610fa87eda75.js></script></head><body><div class="min-h-screen bg-gray-100"><header class="bg-white shadow-sm lg:static lg:overflow-y-visible"><div class="max-w-3xl mx-auto px-4 sm:px-6 lg:max-w-7xl lg:px-8"><div class="relative flex flex-wrap items-center justify-center lg:justify-between"><div class="absolute left-0 py-5 flex-shrink-0 lg:static"><a href=#><span class=sr-only>Workflow</span><svg class="h-8 w-auto" fill="none" viewBox="0 0 35 32" xmlns="http://www.w3.org/2000/svg"><path fill="#a5f3fc" d="M15.258 26.865a4.043 4.043.0 01-1.133 2.917A4.006 4.006.0 0111.253 31a3.992 3.992.0 01-2.872-1.218 4.028 4.028.0 01-1.133-2.917c.009-.698.2-1.382.557-1.981.356-.6.863-1.094 1.47-1.433-.024.109.09-.055.0.0l1.86-1.652a8.495 8.495.0 002.304-5.793c0-2.926-1.711-5.901-4.17-7.457.094.055-.036-.094.0.0A3.952 3.952.0 017.8 7.116a3.975 3.975.0 01-.557-1.98 4.042 4.042.0 011.133-2.918A4.006 4.006.0 0111.247 1a3.99 3.99.0 012.872 1.218 4.025 4.025.0 011.133 2.917 8.521 8.521.0 002.347 5.832l.817.8c.326.285.668.551 1.024.798.621.33 1.142.826 1.504 1.431a3.902 3.902.0 01-1.504 5.442c.033-.067-.063.036.0.0a8.968 8.968.0 00-3.024 3.183 9.016 9.016.0 00-1.158 4.244zM19.741 5.123c0 .796.235 1.575.676 2.237a4.01 4.01.0 001.798 1.482 3.99 3.99.0 004.366-.873 4.042 4.042.0 00.869-4.386 4.02 4.02.0 00-1.476-1.806 3.994 3.994.0 00-5.058.501 4.038 4.038.0 00-1.175 2.845zM23.748 22.84c-.792.0-1.567.236-2.226.678a4.021 4.021.0 00-1.476 1.806 4.042 4.042.0 00.869 4.387 3.99 3.99.0 004.366.873A4.01 4.01.0 0027.08 29.1a4.039 4.039.0 00-.5-5.082 4 4 0 00-2.832-1.18zM34 15.994c0-.796-.235-1.574-.675-2.236a4.01 4.01.0 00-1.798-1.483 3.99 3.99.0 00-4.367.873 4.042 4.042.0 00-.869 4.387 4.02 4.02.0 001.476 1.806 3.993 3.993.0 002.226.678 4.003 4.003.0 002.832-1.18A4.04 4.04.0 0034 15.993zM5.007 11.969c-.793.0-1.567.236-2.226.678a4.021 4.021.0 00-1.476 1.807 4.042 4.042.0 00.869 4.386 4.001 4.001.0 004.366.873 4.011 4.011.0 001.798-1.483 4.038 4.038.0 00-.5-5.08 4.004 4.004.0 00-2.831-1.181z"/></svg></a></div><div class="hidden lg:ml-4 lg:flex lg:items-center lg:py-5 lg:pr-0.5"><div class="ml-4 relative flex-shrink-0"><div><button type=button class="bg-white rounded-full flex text-sm ring-2 ring-white ring-opacity-20 focus:outline-none focus:ring-opacity-100" id=user-menu-button aria-expanded=false aria-haspopup=true>
<span class=sr-only>Open user menu</span>
<img class="h-8 w-8 rounded-full" src=/images/profile.png alt="Yassin Mohamed"></button></div></div></div></div></div><nav class=lg:hidden aria-label=Global><div class="max-w-3xl mx-auto px-2 pt-2 pb-3 space-y-1 sm:px-4"><a href=# aria-current=page class="bg-gray-100 text-gray-900 block rounded-md py-2 px-3 text-base font-medium text-gray-900">Home</a>
<a href=# class="hover:bg-gray-50 block rounded-md py-2 px-3 text-base font-medium text-gray-900">Popular</a></div><div class="border-t border-gray-200 pt-4 pb-3"><div class="max-w-3xl mx-auto px-4 flex items-center sm:px-6"><div class=flex-shrink-0><img class="h-10 w-10 rounded-full" src=/images/profile.png alt="Yassin Mohamed"></div><div class=ml-3><div class="text-base font-medium text-gray-800">Yassin Mohamed</div></div></div><div class="mt-3 max-w-3xl mx-auto px-2 space-y-1 sm:px-4"><a href=# class="block rounded-md py-2 px-3 text-base font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900">Your Profile</a></div></div></nav></header><div class=py-10><div class="max-w-3xl mx-auto sm:px-6 lg:max-w-7xl lg:px-8 lg:grid lg:grid-cols-12 lg:gap-8"><div class="hidden lg:block lg:col-span-3 xl:col-span-2"><nav aria-label=Sidebar class="sticky top-4 divide-y divide-gray-300"><div class="pb-8 space-y-1"><a href=http://yassinm.github.io class="bg-gray-200 text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md" aria-current=page><svg class="text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11 2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class=truncate>Home</span></a>
<a href=# class="text-gray-600 hover:bg-gray-50 group flex items-center px-3 py-2 text-sm font-medium rounded-md"><svg class="text-gray-400 group-hover:text-gray-500 flex-shrink-0 -ml-1 mr-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975.0 0120 13a7.975 7.975.0 01-2.343 5.657z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/></svg><span class=truncate>Popular</span></a></div><div class=pt-10><p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider" id=communities-headline>Tags</p><div class="mt-3 space-y-2" aria-labelledby=communities-headline><a href=http://yassinm.github.io/tags/dataflow/ class="group flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-md hover:text-gray-900 hover:bg-gray-50"><span class=truncate>dataflow</span></a></div><div class="mt-3 space-y-2" aria-labelledby=communities-headline><a href=http://yassinm.github.io/tags/memory/ class="group flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-md hover:text-gray-900 hover:bg-gray-50"><span class=truncate>memory</span></a></div></div></nav></div><main class="lg:col-span-8 xl:col-span-9"><div class="flex flex-col rounded-lg shadow-lg overflow-hidden"><div class="flex-1 bg-white p-6 flex flex-col justify-between"><div class=flex-1><p class="text-sm text-gray-500"><a href=http://yassinm.github.io/2014-09-25-walking-down-memory-lane-02/ class="text-base font-semibold text-indigo-600 hover:text-indigo-500">Walking down memory lane (part 2)</a></p><div class="prose lg:prose-xl prose-indigo"><p><p>As per our previous <a href=http://yassinm.github.io/2014-09-21-walking-down-memory-lane-01/>part 1 article</a> we identified that we need a way to serialize objects into memory in a very efficient manner. To recap here is a picture showing the steps we need to remove when sending/receiving objects over the network.</p><p><img src=/images/walking-down-memory-lane-02-000.png alt=Fig1></p><p>FTR we are still not interested in solving how these troublesome bytes are transferred over the network from one process to another once the data is ready to be transferred. For this article we are leaving this aspect aside and will only concentrate on efficiently storing those objects in memory and manipulating them correctly.</p><h2 id=unsafe-relationships-with-data>Unsafe relationships with data</h2><p>Like we said earlier java has a dark side if you want to really start fiddling with bytes in an unsafe and unprotected manner. This is called (quite rightly) sun.misc.Unsafe. For the gory details i will refer you to this <a href=https://mechanical-sympathy.blogspot.ca/2012/07/native-cc-like-performance-for-java.html>article</a>. What we gain immediately by using this unsafe method are :</p><p>We finally have a way of accessing bytes for read and writes purposes directly just like we used to in c/c++. We can also do so very efficiently and in a very high speed manner.
The code using these objects is not aware of what is happening behind the scene.
For the sake of cache coherency, it is much better to access the memory in a single stride fashion so that we are not jumping back and forth in memory.
Hiding behind an interface</p><h2 id=hiding-behind-an-interface>Hiding behind an interface</h2><p>What we achieved, instantly, by using the “unsafe” method is a read/write through interface. The block of memory behind the object is effectively acting as a cache that we use to read/write behind the scene. The fact that we are dealing with unsafe is only an implementation specific issue. All the code using this interface is unaware of what is happening.</p><p><img src=/images/walking-down-memory-lane-02-001.png alt=Fig2></p><p>This effectively means that the memory backing these objects could come from anywhere in the system ! We are not limited by the limitations of heap memory and its cumbersome garbage collection schemes. The gates are open for an infinite amount of unmanaged off-heap memory ! In fact, we are not even limited by the memory available on the process altogether. We could use a shared memory scheme where all the data could be read/written by a separate locally running process. Or for that matter anything that was published by the kernel in a memory location somewhere on the system !!! As long as we can address the memory in a progressive single stride fashion we can effectively address anything located locally or somewhere else on the universe. More on this later …</p><h2 id=sharing-is-messaging->Sharing is messaging !</h2><p>As we said above the memory that is living behind the proxy object could also be a shared memory location. As long as we take care of how we are accessing these memory locations concurrently we can effectively send messages between local threads running within the same process !</p><p><img src=/images/walking-down-memory-lane-02-002.png alt=Fig3></p><p>In the same vein it is not a big stretch to see how this technique could be applied to threads running across a multitude of processes running within the same machine or running on different geographically located data centres as part of a big cluster. It is only a matter of making sure the objects see the exact same data copied verbatim across those process boundaries. The biggest technical hurdle that is left to overcome is the synchronization mechanism we will use to make sure we are accessing these objects safely. Of course it will also have to be a very fast synchronization mechanism or we will lose the benefit of doing all these magical memory fiddling contraptions!</p><p>Furthermore, if we keep accessing memory with the Single Writer Principle in mind we might be able to share this memory location with more than one reader in a non contention based fashion. To quote that page ‘On x86/x64 loads can be re-ordered with older stores according to the memory model so memory barriers are required when multiple threads mutate the same data across cores. The single writer principle avoids this issue because it never has to deal with writing the latest version of a data item that may have been written by another thread and currently in the store buffer of another core”. But let us not go ahead of ourself here, we are not there yet !</p><p>One thing that you (maybe) missed to notice is that i completely ignored talking about how we were going to turn our objects to memory bytes via the serialization step which we set out to fix in the beginning of this article. As you can see that step is unnecessary since the code using our fine grained fly weight proxy object is directly reading and writing to the bytes locations. As such, when the user code calls the set functions on the proxy object we are technically performing the serialization to memory right away. Vice versa, when the user calls the get functions available on the proxy object they are effectively de-serializing the object from memory. All of the above is done efficiently and with minimal locking involved … Et voila !</p><h2 id=do-you-know-the-memory-man--the-memory-man--who-lives-on-drury-lane->Do you know the memory man ? the memory man ? who lives on Drury Lane ?</h2><p>Now one more little titbit remaining is that the process or thread we are sharing our data with does not have to be written in java at all. It could be written in any language binding that can use our proxy object. It can be in Java,c#,c/c++,erlang, ruby,nodejs, python , php … you name it. It just does not matter at all. Like we said before ,for all intents and purposes , it could be coming from the kernel itself. As long as the memory representation and location is followed we can both communicate over this high speed channel. Imagine a world where you could write your database access in Java and your number crunching in c/c++. And they could be both living within the same process or across from two separate data centers !</p><h2 id=conclusion>Conclusion</h2><p>We started with solving a simple serialization/de-serialization problem and we are already talking about fixing the inherent communication problems when people want to mix code written for different platforms and with different languages without sacrificing performance. I would say that this side effect is a very beautiful addition to solving our original problem(s). Assuming it works out … obviously !</p><p>Until we get there i can always say that “I have a dream … I have a dream that one day down in a process — with its vicious language base discrimination , with its OS having its lips dripping with the words of interposition and nullification — one day right there in a process, little java boys and c# girls will be able to join hands with little c/c++ boys and ruby girls as sisters and brothers. I have a dream that one day every valley shall be exalted, and every hill and mountain shall be made low. The rough places will be plain and the crooked places will be made straight, and the glory of all languages shall be revealed”</p><p>So stay tuned for that dream to come true !</p></p></div></div></div></div></main></div></div></div></body></html>